import streamlit as st
from groq import Groq
from gtts import gTTS
import io
import uuid
from streamlit_mic_recorder import mic_recorder # ‡∞µ‡∞æ‡∞Ø‡∞ø‡∞∏‡±ç ‡∞á‡∞®‡±ç‚Äå‡∞™‡±Å‡∞ü‡±ç ‡∞ï‡±ã‡∞∏‡∞Ç

# --- 1. ‡∞™‡±á‡∞ú‡±Ä ‡∞∏‡±Ü‡∞ü‡±ç‡∞ü‡∞ø‡∞Ç‡∞ó‡±ç‡∞∏‡±ç ---
st.set_page_config(page_title="Mitra AI - Complete Guide", layout="wide", page_icon="üßò")

# --- 2. ‡∞á‡∞®‡∞ø‡∞∑‡∞ø‡∞Ø‡∞≤‡±à‡∞ú‡±á‡∞∑‡∞®‡±ç ---
if "chat_history" not in st.session_state:
    st.session_state.chat_history = {}  
if "current_chat_id" not in st.session_state:
    st.session_state.current_chat_id = None
if "ai_memory" not in st.session_state:
    st.session_state.ai_memory = "‡∞®‡±Ä ‡∞™‡±á‡∞∞‡±Å ‡∞Æ‡∞ø‡∞§‡±ç‡∞∞. ‡∞®‡±Å‡∞µ‡±ç‡∞µ‡±Å ‡∞¨‡±ç‡∞∞‡∞π‡±ç‡∞Æ‡∞ï‡±Å‡∞Æ‡∞æ‡∞∞‡∞ø‡∞∏‡±ç ‡∞Ü‡∞ß‡±ç‡∞Ø‡∞æ‡∞§‡±ç‡∞Æ‡∞ø‡∞ï ‡∞Æ‡∞æ‡∞∞‡±ç‡∞ó‡∞¶‡∞∞‡±ç‡∞∂‡∞ø‡∞µ‡∞ø."

def get_groq_client():
    try:
        return Groq(api_key=st.secrets["GROQ_API_KEY"])
    except:
        st.error("‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø Streamlit Secrets ‡∞≤‡±ã GROQ_API_KEY ‡∞®‡∞ø ‡∞∏‡±Ü‡∞ü‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø.")
        return None

client = get_groq_client()

# --- 3. ‡∞∏‡±à‡∞°‡±ç ‡∞¨‡∞æ‡∞∞‡±ç (‡∞ö‡∞æ‡∞ü‡±ç ‡∞π‡∞ø‡∞∏‡±ç‡∞ü‡∞∞‡±Ä & ‡∞∏‡±Ü‡∞ü‡±ç‡∞ü‡∞ø‡∞Ç‡∞ó‡±ç‡∞∏‡±ç) ---
with st.sidebar:
    st.title("üïâÔ∏è ‡∞Æ‡∞ø‡∞§‡±ç‡∞∞ ‡∞ï‡∞Ç‡∞ü‡±ç‡∞∞‡±ã‡∞≤‡±ç‡∞∏‡±ç")
    
    if st.button("‚ûï ‡∞ï‡±ä‡∞§‡±ç‡∞§ ‡∞ö‡∞æ‡∞ü‡±ç", use_container_width=True):
        new_id = str(uuid.uuid4())
        st.session_state.chat_history[new_id] = {"title": "‡∞ï‡±ä‡∞§‡±ç‡∞§ ‡∞∏‡∞Ç‡∞≠‡∞æ‡∞∑‡∞£", "messages": []}
        st.session_state.current_chat_id = new_id
        st.rerun()

    st.divider()
    st.subheader("‡∞Æ‡±Ä ‡∞∏‡∞Ç‡∞≠‡∞æ‡∞∑‡∞£‡∞≤‡±Å")
    for chat_id in list(st.session_state.chat_history.keys()):
        col1, col2 = st.columns([0.8, 0.2])
        with col1:
            if st.button(st.session_state.chat_history[chat_id]["title"], key=f"btn_{chat_id}", use_container_width=True):
                st.session_state.current_chat_id = chat_id
                st.rerun()
        with col2:
            if st.button("üóëÔ∏è", key=f"del_{chat_id}"):
                del st.session_state.chat_history[chat_id]
                if st.session_state.current_chat_id == chat_id:
                    st.session_state.current_chat_id = None
                st.rerun()

    st.divider()
    with st.expander("‚öôÔ∏è ‡∞è‡∞ê ‡∞Æ‡±Ü‡∞Æ‡∞∞‡±Ä ‡∞∏‡±Ü‡∞ü‡±ç‡∞ü‡∞ø‡∞Ç‡∞ó‡±ç‡∞∏‡±ç"):
        new_memory = st.text_area("‡∞è‡∞ê‡∞ï‡∞ø ‡∞ó‡±Å‡∞∞‡±ç‡∞§‡±Å‡∞Ç‡∞°‡∞µ‡∞≤‡∞∏‡∞ø‡∞® ‡∞µ‡∞ø‡∞∑‡∞Ø‡∞æ‡∞≤‡±Å:", value=st.session_state.ai_memory, height=150)
        if st.button("‡∞ú‡±ç‡∞û‡∞æ‡∞™‡∞ï‡∞æ‡∞≤‡∞®‡±Å ‡∞∏‡±á‡∞µ‡±ç ‡∞ö‡±á‡∞Ø‡∞ø"):
            st.session_state.ai_memory = new_memory
            st.success("‡∞∏‡±á‡∞µ‡±ç ‡∞ö‡±á‡∞Ø‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø!")

# --- 4. ‡∞™‡±ç‡∞∞‡∞ß‡∞æ‡∞® ‡∞∏‡±ç‡∞ï‡±ç‡∞∞‡±Ä‡∞®‡±ç ---
st.header("üî± ‡∞Æ‡∞ø‡∞§‡±ç‡∞∞ - ‡∞Ü‡∞ß‡±ç‡∞Ø‡∞æ‡∞§‡±ç‡∞Æ‡∞ø‡∞ï ‡∞ú‡±ç‡∞û‡∞æ‡∞® ‡∞µ‡±á‡∞¶‡∞ø‡∞ï")

if not st.session_state.current_chat_id:
    st.info("‡∞é‡∞°‡∞Æ‡∞µ‡±à‡∞™‡±Å '‡∞ï‡±ä‡∞§‡±ç‡∞§ ‡∞ö‡∞æ‡∞ü‡±ç' ‡∞ï‡±ç‡∞≤‡∞ø‡∞ï‡±ç ‡∞ö‡±á‡∞∏‡∞ø ‡∞™‡±ç‡∞∞‡∞æ‡∞∞‡∞Ç‡∞≠‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø.")
    st.stop()

current_chat = st.session_state.chat_history[st.session_state.current_chat_id]

# ‡∞Æ‡±Ü‡∞∏‡±á‡∞ú‡±ç ‡∞ï‡±ç‡∞≤‡±Ä‡∞®‡∞ø‡∞Ç‡∞ó‡±ç ‡∞´‡∞Ç‡∞ï‡±ç‡∞∑‡∞®‡±ç (‡∞Ü‡∞°‡∞ø‡∞Ø‡±ã ‡∞ï‡±ã‡∞∏‡∞Ç)
def clean_for_audio(text):
    return text.replace("*", "").replace("#", "").replace("`", "").strip()

# ‡∞Æ‡±Ü‡∞∏‡±á‡∞ú‡±ç‚Äå‡∞≤‡∞®‡±Å ‡∞™‡±ç‡∞∞‡∞¶‡∞∞‡±ç‡∞∂‡∞ø‡∞Ç‡∞ö‡∞°‡∞Ç
for idx, m in enumerate(current_chat["messages"]):
    with st.chat_message(m["role"]):
        st.markdown(m["content"])
        
        # ‡∞Ü‡∞°‡∞ø‡∞Ø‡±ã ‡∞Ö‡∞µ‡±Å‡∞ü‡±ç‚Äå‡∞™‡±Å‡∞ü‡±ç (‡∞∏‡∞π‡∞æ‡∞Ø‡∞ï‡±Å‡∞°‡±Å ‡∞ö‡±Ü‡∞™‡±ç‡∞™‡∞ø‡∞® ‡∞∏‡∞Æ‡∞æ‡∞ß‡∞æ‡∞®‡∞Ç ‡∞ï‡±ã‡∞∏‡∞Ç)
        if m["role"] == "assistant":
            try:
                clean_text = clean_for_audio(m["content"])
                tts = gTTS(text=clean_text, lang='te')
                audio_fp = io.BytesIO()
                tts.write_to_fp(audio_fp)
                st.audio(audio_fp, format="audio/mp3")
            except: pass

        # ‡∞ï‡∞Ç‡∞ü‡±ç‡∞∞‡±ã‡∞≤‡±ç‡∞∏‡±ç (‡∞°‡∞ø‡∞≤‡±Ä‡∞ü‡±ç & ‡∞∏‡±á‡∞µ‡±ç)
        col1, col2, _ = st.columns([0.05, 0.05, 0.9])
        with col1:
            if st.button("üóëÔ∏è", key=f"msg_del_{idx}"):
                current_chat["messages"].pop(idx)
                st.rerun()
        with col2:
            st.download_button("üíæ", m["content"], file_name="mitra_msg.txt", key=f"save_{idx}")

# --- 5. ‡∞µ‡∞æ‡∞Ø‡∞ø‡∞∏‡±ç ‡∞á‡∞®‡±ç‚Äå‡∞™‡±Å‡∞ü‡±ç & ‡∞ü‡±Ü‡∞ï‡±ç‡∞∏‡±ç‡∞ü‡±ç ‡∞á‡∞®‡±ç‚Äå‡∞™‡±Å‡∞ü‡±ç ---
st.divider()
col_mic, col_txt = st.columns([0.1, 0.9])

with col_mic:
    # ‡∞µ‡∞æ‡∞Ø‡∞ø‡∞∏‡±ç ‡∞∞‡∞ø‡∞ï‡∞æ‡∞∞‡±ç‡∞°‡∞∞‡±ç
    audio_input = mic_recorder(start_prompt="üé§", stop_prompt="üî¥", key='recorder')

with col_txt:
    user_input = st.chat_input("‡∞Æ‡±Ä ‡∞Ü‡∞ß‡±ç‡∞Ø‡∞æ‡∞§‡±ç‡∞Æ‡∞ø‡∞ï ‡∞∏‡∞Ç‡∞¶‡±á‡∞π‡∞æ‡∞®‡±ç‡∞®‡∞ø ‡∞á‡∞ï‡±ç‡∞ï‡∞° ‡∞Ö‡∞°‡∞ó‡∞Ç‡∞°‡∞ø...")

# ‡∞µ‡∞æ‡∞Ø‡∞ø‡∞∏‡±ç ‡∞á‡∞®‡±ç‚Äå‡∞™‡±Å‡∞ü‡±ç ‡∞™‡±ç‡∞∞‡∞æ‡∞∏‡±Ü‡∞∏‡∞ø‡∞Ç‡∞ó‡±ç (‡∞í‡∞ï‡∞µ‡±á‡∞≥ ‡∞µ‡∞æ‡∞Ø‡∞ø‡∞∏‡±ç ‡∞¶‡±ç‡∞µ‡∞æ‡∞∞‡∞æ ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞® ‡∞µ‡∞∏‡±ç‡∞§‡±á)
if audio_input:
    # ‡∞ó‡∞Æ‡∞®‡∞ø‡∞ï: Groq ‡∞≤‡±ã 'distil-whisper-large-v3-en' ‡∞µ‡∞æ‡∞°‡∞ø ‡∞µ‡∞æ‡∞Ø‡∞ø‡∞∏‡±ç ‡∞ü‡±Å ‡∞ü‡±Ü‡∞ï‡±ç‡∞∏‡±ç‡∞ü‡±ç ‡∞ö‡±á‡∞Ø‡∞µ‡∞ö‡±ç‡∞ö‡±Å
    # ‡∞™‡±ç‡∞∞‡∞∏‡±ç‡∞§‡±Å‡∞§‡∞æ‡∞®‡∞ø‡∞ï‡∞ø ‡∞Ø‡±Ç‡∞ú‡∞∞‡±ç ‡∞ü‡±Ü‡∞ï‡±ç‡∞∏‡±ç‡∞ü‡±ç ‡∞¨‡∞æ‡∞ï‡±ç‡∞∏‡±ç ‡∞≤‡±á‡∞¶‡∞æ ‡∞µ‡∞æ‡∞Ø‡∞ø‡∞∏‡±ç ‡∞∞‡∞ø‡∞ï‡∞æ‡∞∞‡±ç‡∞°‡∞ø‡∞Ç‡∞ó‡±ç ‡∞™‡±à ‡∞¶‡±É‡∞∑‡±ç‡∞ü‡∞ø ‡∞™‡±Ü‡∞ü‡±ç‡∞ü‡∞æ‡∞Ç
    st.warning("‡∞µ‡∞æ‡∞Ø‡∞ø‡∞∏‡±ç ‡∞∞‡∞ø‡∞ï‡∞æ‡∞∞‡±ç‡∞°‡∞ø‡∞Ç‡∞ó‡±ç ‡∞™‡±Ç‡∞∞‡±ç‡∞§‡∞Ø‡∞ø‡∞Ç‡∞¶‡∞ø. (‡∞µ‡∞æ‡∞Ø‡∞ø‡∞∏‡±ç-‡∞ü‡±Å-‡∞ü‡±Ü‡∞ï‡±ç‡∞∏‡±ç‡∞ü‡±ç ‡∞ï‡±ã‡∞∏‡∞Ç ‡∞µ‡∞ø‡∞∏‡±ç‡∞™‡∞∞‡±ç‚Äå‡∞®‡∞ø ‡∞ú‡±ã‡∞°‡∞ø‡∞Ç‡∞ö‡∞µ‡∞ö‡±ç‡∞ö‡±Å)")

# --- 6. ‡∞è‡∞ê ‡∞∞‡±Ü‡∞∏‡±ç‡∞™‡∞æ‡∞®‡±ç‡∞∏‡±ç ‡∞´‡∞Ç‡∞ï‡±ç‡∞∑‡∞®‡±ç ---
def ask_mitra(prompt, history):
    system_prompt = f"{st.session_state.ai_memory}\n\n‡∞Æ‡±Å‡∞ñ‡±ç‡∞Ø‡∞Ç‡∞ó‡∞æ ‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å‡∞≤‡±ã ‡∞Æ‡∞æ‡∞§‡±ç‡∞∞‡∞Æ‡±á ‡∞∏‡∞Æ‡∞æ‡∞ß‡∞æ‡∞®‡∞Ç ‡∞á‡∞µ‡±ç‡∞µ‡∞æ‡∞≤‡∞ø."
    messages = [{"role": "system", "content": system_prompt}]
    for h in history[-5:]: messages.append(h)
    messages.append({"role": "user", "content": prompt})

    try:
        response = client.chat.completions.create(
            model="llama-3.3-70b-versatile",
            messages=messages,
            temperature=0.7
        )
        return response.choices[0].message.content
    except Exception as e:
        return f"‡∞≤‡±ã‡∞™‡∞Ç: {e}"

# ‡∞Æ‡±Ü‡∞∏‡±á‡∞ú‡±ç ‡∞™‡±ç‡∞∞‡∞æ‡∞∏‡±Ü‡∞∏‡∞ø‡∞Ç‡∞ó‡±ç
if user_input:
    current_chat["messages"].append({"role": "user", "content": user_input})
    if len(current_chat["messages"]) <= 2:
        current_chat["title"] = user_input[:15] + "..."
    
    with st.chat_message("user"): st.markdown(user_input)
    with st.chat_message("assistant"):
        with st.spinner("‡∞Æ‡∞ø‡∞§‡±ç‡∞∞ ‡∞Ü‡∞≤‡±ã‡∞ö‡∞ø‡∞∏‡±ç‡∞§‡±Å‡∞®‡±ç‡∞®‡∞æ‡∞°‡±Å..."):
            answer = ask_mitra(user_input, current_chat["messages"][:-1])
            st.markdown(answer)
            current_chat["messages"].append({"role": "assistant", "content": answer})
            
            # ‡∞µ‡±Ü‡∞Ç‡∞ü‡∞®‡±á ‡∞Ü‡∞°‡∞ø‡∞Ø‡±ã ‡∞™‡±ç‡∞≤‡±á ‡∞ö‡±á‡∞Ø‡∞°‡∞Ç
            clean_text = clean_for_audio(answer)
            tts = gTTS(text=clean_text, lang='te')
            f = io.BytesIO(); tts.write_to_fp(f)
            st.audio(f)
    st.rerun()
